/*! event-engine lib - v1.0.0 -2018-03-15 */
window.EventEngine=function(){function t(e){var c=this;if(this.eventRegistry={},this.socketOpen=!1,!e.url)throw"event stream url missing";this.eventStream=new ReconnectingWebSocket(e.url,null,{debug:!0,fetchUrlCallback:e.callbackForNewUrl}),this.eventStream.onopen=function(e){for(var t in c.socketOpen=!0,c.eventRegistry){var n=c.eventRegistry[t];c.addListener(n.query,n.callback,t)}},this.eventStream.onmessage=function(e){var t=e.data,n=JSON.parse(t);if("CALLBACK"===n.opCode){var o=c.eventRegistry[n.registryId];o&&o.callback(n.event)}},this.eventStream.onclose=function(e){c.socketOpen=!1},this.keepalive()}return t.prototype.keepalive=function(){this.socketOpen&&this.eventStream.send(JSON.stringify({opCode:"PING"}));var e=this;setTimeout(function(){e.keepalive()},3e4)},t.prototype.addListener=function(e,t,n){if(!t)throw"callback function not provided";if(!e)throw"query not provided";return n||(n=Math.random().toString(36)),this.eventRegistry[n]={query:e,callback:t},this.socketOpen&&this.eventStream.send(JSON.stringify({opCode:"REGISTER_CALLBACK",query:e,registryId:n})),n},t.prototype.removeListener=function(e){this.socketOpen&&this.eventStream.send(JSON.stringify({opCode:"UNREGISTER_CALLBACK",registryId:e}))},t.prototype.close=function(){this.socketOpen=!1,this.eventRegistry={},this.eventStream&&(this.eventStream.close(),this.eventStream=null)},{get:function(e){return new t(e)}}}(),function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.ReconnectingWebSocket=t()}(this,function(){if("WebSocket"in window)return d.prototype.onopen=function(e){},d.prototype.onclose=function(e){},d.prototype.onconnecting=function(e){},d.prototype.onmessage=function(e){},d.prototype.onerror=function(e){},d.debugAll=!1,d.CONNECTING=WebSocket.CONNECTING,d.OPEN=WebSocket.OPEN,d.CLOSING=WebSocket.CLOSING,d.CLOSED=WebSocket.CLOSED,d;function d(e,c,t){var n={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob",fetchUrlCallback:""};for(var o in t||(t={}),n)void 0!==t[o]?this[o]=t[o]:this[o]=n[o];this.url=e,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var i,r=this,s=!1,a=!1,u=document.createElement("div");function l(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}u.addEventListener("open",function(e){r.onopen(e)}),u.addEventListener("close",function(e){r.onclose(e)}),u.addEventListener("connecting",function(e){r.onconnecting(e)}),u.addEventListener("message",function(e){r.onmessage(e)}),u.addEventListener("error",function(e){r.onerror(e)}),this.addEventListener=u.addEventListener.bind(u),this.removeEventListener=u.removeEventListener.bind(u),this.dispatchEvent=u.dispatchEvent.bind(u),this.open=function(o,e){if(e&&(this.url=e),(i=new WebSocket(r.url,c||[])).binaryType=this.binaryType,o){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else u.dispatchEvent(l("connecting")),this.reconnectAttempts=0;(r.debug||d.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",r.url);var t=i,n=setTimeout(function(){(r.debug||d.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",r.url),a=!0,t.close(),a=!1},r.timeoutInterval);i.onopen=function(e){clearTimeout(n),(r.debug||d.debugAll)&&console.debug("ReconnectingWebSocket","onopen",r.url),r.protocol=i.protocol,r.readyState=WebSocket.OPEN,r.reconnectAttempts=0;var t=l("open");t.isReconnect=o,o=!1,u.dispatchEvent(t)},i.onclose=function(e){if(clearTimeout(n),i=null,s)r.readyState=WebSocket.CLOSED,u.dispatchEvent(l("close"));else{r.readyState=WebSocket.CONNECTING;var t=l("connecting");t.code=e.code,t.reason=e.reason,t.wasClean=e.wasClean,u.dispatchEvent(t),o||a||((r.debug||d.debugAll)&&console.debug("ReconnectingWebSocket","onclose",r.url),u.dispatchEvent(l("close")));var n=r.reconnectInterval*Math.pow(r.reconnectDecay,r.reconnectAttempts);setTimeout(function(){r.reconnectAttempts++,r.fetchUrlCallback().then(function(e){var t=e.url?e.url:r.url;r.open(!0,t)})},n>r.maxReconnectInterval?r.maxReconnectInterval:n)}},i.onmessage=function(e){(r.debug||d.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",r.url,e.data);var t=l("message");t.data=e.data,u.dispatchEvent(t)},i.onerror=function(e){(r.debug||d.debugAll)&&console.debug("ReconnectingWebSocket","onerror",r.url,e),u.dispatchEvent(l("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(e){if(i)return(r.debug||d.debugAll)&&console.debug("ReconnectingWebSocket","send",r.url,e),i.send(e);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){void 0===e&&(e=1e3),s=!0,i&&i.close(e,t)},this.refresh=function(){i&&i.close()}}});