/*! event-engine lib - v1.0.0 -2018-01-31 */
window.EventEngine=function(){function e(e){var t=this;if(this.eventRegistry={},this.socketOpen=!1,!e.url)throw"event stream url missing";this.eventStream=new ReconnectingWebSocket(e.url),this.eventStream.onopen=function(e){t.socketOpen=!0;for(var n in t.eventRegistry){var o=t.eventRegistry[n];t.addListener(o.query,o.callback,n)}},this.eventStream.onmessage=function(e){var n=e.data,o=JSON.parse(n);if("CALLBACK"===o.opCode){var c=t.eventRegistry[o.registryId];c&&c.callback(o.event)}},this.eventStream.onclose=function(e){t.socketOpen=!1},this.keepalive()}e.prototype.keepalive=function(){this.socketOpen&&this.eventStream.send(JSON.stringify({opCode:"PING"}));var e=this;setTimeout(function(){e.keepalive()},3e4)},e.prototype.addListener=function(e,t,n){if(!t)throw"callback function not provided";if(!e)throw"query not provided";return n||(n=Math.random().toString(36)),this.eventRegistry[n]={query:e,callback:t},this.socketOpen&&this.eventStream.send(JSON.stringify({opCode:"REGISTER_CALLBACK",query:e,registryId:n})),n},e.prototype.removeListener=function(e){this.socketOpen&&this.eventStream.send(JSON.stringify({opCode:"UNREGISTER_CALLBACK",registryId:e}))};return{get:function(t){return new e(t)}}}(),function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.ReconnectingWebSocket=t()}(this,function(){if("WebSocket"in window)return e.prototype.onopen=function(e){},e.prototype.onclose=function(e){},e.prototype.onconnecting=function(e){},e.prototype.onmessage=function(e){},e.prototype.onerror=function(e){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e;function e(t,n,o){var c={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null};o||(o={});for(var i in c)void 0!==o[i]?this[i]=o[i]:this[i]=c[i];this.url=t,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var r,s=this,a=!1,u=!1,d=document.createElement("div");d.addEventListener("open",function(e){s.onopen(e)}),d.addEventListener("close",function(e){s.onclose(e)}),d.addEventListener("connecting",function(e){s.onconnecting(e)}),d.addEventListener("message",function(e){s.onmessage(e)}),d.addEventListener("error",function(e){s.onerror(e)}),this.addEventListener=d.addEventListener.bind(d),this.removeEventListener=d.removeEventListener.bind(d),this.dispatchEvent=d.dispatchEvent.bind(d);function l(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}this.open=function(t){if(r=new WebSocket(s.url,n||[]),t){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else d.dispatchEvent(l("connecting")),this.reconnectAttempts=0;(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",s.url);var o=r,c=setTimeout(function(){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",s.url),u=!0,o.close(),u=!1},s.timeoutInterval);r.onopen=function(n){clearTimeout(c),(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",s.url),s.protocol=r.protocol,s.readyState=WebSocket.OPEN,s.reconnectAttempts=0;var o=l("open");o.isReconnect=t,t=!1,d.dispatchEvent(o)},r.onclose=function(n){if(clearTimeout(c),r=null,a)s.readyState=WebSocket.CLOSED,d.dispatchEvent(l("close"));else{s.readyState=WebSocket.CONNECTING;var o=l("connecting");o.code=n.code,o.reason=n.reason,o.wasClean=n.wasClean,d.dispatchEvent(o),t||u||((s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",s.url),d.dispatchEvent(l("close")));var c=s.reconnectInterval*Math.pow(s.reconnectDecay,s.reconnectAttempts);setTimeout(function(){s.reconnectAttempts++,s.open(!0)},c>s.maxReconnectInterval?s.maxReconnectInterval:c)}},r.onmessage=function(t){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",s.url,t.data);var n=l("message");n.data=t.data,d.dispatchEvent(n)},r.onerror=function(t){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",s.url,t),d.dispatchEvent(l("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(r)return(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",s.url,t),r.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){void 0===e&&(e=1e3),a=!0,r&&r.close(e,t)},this.refresh=function(){r&&r.close()}}});